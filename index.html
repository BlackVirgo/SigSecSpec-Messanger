<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoliceComm - Tactical Communications System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto Condensed', 'Arial Black', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d30 50%, #1e1e1e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #e0e0e0;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            background: #1e1e1e;
            border: 2px solid #404040;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
        }

        .login-box {
            background: #2d2d30;
            padding: 40px;
            border: 2px solid #404040;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #00aaff;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .login-box p {
            color: #b0b0b0;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #e0e0e0;
            transition: border-color 0.3s;
        }

        .form-group select:focus {
            outline: none;
            border-color: #00aaff;
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.3);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            border: 2px solid #0088ff;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-login:hover {
            background: linear-gradient(135deg, #0088ff 0%, #0066cc 100%);
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.5);
            transform: translateY(-1px);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d30 100%);
            border-bottom: 3px solid #00aaff;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #00aaff;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: rgba(0, 170, 255, 0.2);
            border: 1px solid #00aaff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-logout {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 0, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #252526;
            border-right: 2px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid #404040;
            background: #2d2d30;
        }

        .sidebar-header h2 {
            font-size: 16px;
            color: #00aaff;
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: all 0.2s;
            background: #252526;
        }

        .chat-item:hover {
            background: #2d2d30;
            border-left: 3px solid #00aaff;
        }

        .chat-item.active {
            background: #0066cc;
            color: white;
            border-left: 4px solid #00aaff;
            box-shadow: inset 0 0 10px rgba(0, 170, 255, 0.3);
        }

        .chat-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-badge {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 2px;
            background: rgba(0, 170, 255, 0.2);
            border: 1px solid #00aaff;
            color: #00aaff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-item.active .chat-badge {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
            color: white;
        }

        .chat-item-subtitle {
            font-size: 12px;
            color: #b0b0b0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .chat-item.active .chat-item-subtitle {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 2px solid #404040;
            background: #2d2d30;
        }

        .chat-header h3 {
            font-size: 16px;
            color: #00aaff;
            margin-bottom: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chat-header p {
            font-size: 12px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            background: #1a1a1a;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }

        .message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-header {
            font-size: 11px;
            color: #b0b0b0;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            border: 1px solid #0088ff;
            color: white;
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        .message.received .message-bubble {
            background: #2d2d30;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-bottom-left-radius: 4px;
            font-weight: 500;
        }

        .message-time {
            font-size: 10px;
            color: #808080;
            margin-top: 4px;
            font-weight: 600;
        }

        .supervision-notice {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #ffaa00;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #ffaa00;
            font-weight: 600;
        }

        /* Input Area */
        .input-area {
            padding: 20px 30px;
            border-top: 2px solid #404040;
            background: #2d2d30;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #404040;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #e0e0e0;
            transition: all 0.3s;
        }

        .input-container input:focus {
            outline: none;
            border-color: #00aaff;
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.3);
        }

        .btn-send {
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            color: white;
            border: 2px solid #0088ff;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-send:hover {
            background: linear-gradient(135deg, #0088ff 0%, #0066cc 100%);
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.5);
            transform: scale(1.02);
        }

        .btn-send:active {
            transform: scale(0.95);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #808080;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0088ff;
        }

        /* Police Tactical Styling */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #00ff00; }
        .status-busy { background: #ff4444; }
        .status-away { background: #ffaa00; }
        .status-offline { background: #666666; }
        
        .priority-high {
            border-left: 4px solid #ff4444 !important;
            background: rgba(255, 68, 68, 0.1) !important;
        }
        
        .priority-urgent {
            border-left: 4px solid #ff0000 !important;
            background: rgba(255, 0, 0, 0.15) !important;
            animation: urgentPulse 1s infinite;
        }
        
        @keyframes urgentPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
        }
        
        .tactical-header {
            background: linear-gradient(90deg, #1a1a1a 0%, #0066cc 50%, #1a1a1a 100%);
            height: 4px;
            margin-bottom: 10px;
        }
        
        .badge-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00aaff;
            font-size: 11px;
        }
        
        .secure-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .timestamp-tactical {
            font-family: 'Courier New', monospace;
            color: #808080;
            font-size: 10px;
            font-weight: bold;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .app-container {
                height: 95vh;
                border-radius: 4px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 2px solid #404040;
            }
            
            .chat-list {
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .chat-item {
                min-width: 200px;
                border-right: 1px solid #404040;
                border-bottom: none;
            }
            
            .app-header {
                padding: 10px 20px;
            }
            
            .app-header h1 {
                font-size: 18px;
            }
            
            .user-badge {
                font-size: 10px;
                padding: 6px 12px;
            }
            
            .btn-logout {
                font-size: 10px;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                height: 150px;
            }
            
            .chat-item {
                min-width: 150px;
                padding: 12px 15px;
            }
            
            .messages-container {
                padding: 15px 20px;
            }
            
            .input-area {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Police Rank Hierarchy Configuration
        const ROLES = {
            CIVILIAN: { name: 'Civilian', level: 0, badge: 'CIV' },
            CADET: { name: 'Police Cadet', level: 1, badge: 'CDT' },
            OFFICER: { name: 'Police Officer', level: 2, badge: 'PO' },
            CORPORAL: { name: 'Corporal', level: 3, badge: 'CPL' },
            SERGEANT: { name: 'Sergeant', level: 4, badge: 'SGT' },
            LIEUTENANT: { name: 'Lieutenant', level: 5, badge: 'LT' },
            CAPTAIN: { name: 'Captain', level: 6, badge: 'CAPT' },
            DISPATCHER: { name: 'Dispatcher', level: 7, badge: 'DISP' },
            DETECTIVE: { name: 'Detective', level: 8, badge: 'DET' },
            COMMANDER: { name: 'Commander', level: 9, badge: 'CMD' },
            CHIEF: { name: 'Chief of Police', level: 10, badge: 'CHIEF' }
        };

        // Police Personnel Database
        const USERS = {
            civilian001: { username: 'civilian001', role: ROLES.CIVILIAN, displayName: 'John Doe', badge: 'N/A', status: 'offline' },
            cadet001: { username: 'cadet001', role: ROLES.CADET, displayName: 'Sarah Johnson', badge: '1001', status: 'online' },
            officer001: { username: 'officer001', role: ROLES.OFFICER, displayName: 'Mike Rodriguez', badge: '2001', status: 'online' },
            corporal001: { username: 'corporal001', role: ROLES.CORPORAL, displayName: 'Lisa Chen', badge: '3001', status: 'busy' },
            sergeant001: { username: 'sergeant001', role: ROLES.SERGEANT, displayName: 'David Thompson', badge: '4001', status: 'online' },
            lieutenant001: { username: 'lieutenant001', role: ROLES.LIEUTENANT, displayName: 'Amanda Wilson', badge: '5001', status: 'away' },
            captain001: { username: 'captain001', role: ROLES.CAPTAIN, displayName: 'Robert Martinez', badge: '6001', status: 'online' },
            dispatcher001: { username: 'dispatcher001', role: ROLES.DISPATCHER, displayName: 'Emily Davis', badge: 'D001', status: 'online' },
            detective001: { username: 'detective001', role: ROLES.DETECTIVE, displayName: 'James Anderson', badge: 'DT001', status: 'busy' },
            commander001: { username: 'commander001', role: ROLES.COMMANDER, displayName: 'Patricia Brown', badge: 'CMD001', status: 'online' },
            chief001: { username: 'chief001', role: ROLES.CHIEF, displayName: 'William Garcia', badge: 'CHIEF', status: 'away' }
        };

        // Police Communication Channels
        const CHAT_TYPES = {
            PATROL: 'Patrol Comm',
            TACTICAL: 'Tactical Ops',
            DISPATCH: 'Dispatch',
            INVESTIGATION: 'Investigation',
            COMMAND: 'Command',
            TRAINING: 'Training',
            ADMIN: 'Administration',
            EMERGENCY: 'Emergency'
        };

        // Define communication channels based on police ranks
        const getChatConfigurations = (currentUser) => {
            const configs = [];

            if (currentUser.role === ROLES.OFFICER || currentUser.role === ROLES.CADET) {
                configs.push(
                    { type: CHAT_TYPES.PATROL, participants: ['officer001', 'corporal001'], description: 'Street patrol coordination and updates' },
                    { type: CHAT_TYPES.TRAINING, participants: ['cadet001', 'sergeant001'], description: 'Training protocols and field guidance' },
                    { type: CHAT_TYPES.DISPATCH, participants: ['officer001', 'dispatcher001'], description: 'Real-time dispatch communications' },
                    { type: CHAT_TYPES.COMMAND, participants: ['officer001', 'lieutenant001', 'captain001'], description: 'Command structure communications' }
                );
            } else if (currentUser.role === ROLES.CORPORAL) {
                configs.push(
                    { type: CHAT_TYPES.PATROL, participants: ['officer001', 'corporal001'], description: 'Patrol supervision and coordination' },
                    { type: CHAT_TYPES.TACTICAL, participants: ['corporal001', 'sergeant001'], description: 'Tactical operations planning' },
                    { type: CHAT_TYPES.COMMAND, participants: ['corporal001', 'lieutenant001'], description: 'Command reporting' }
                );
            } else if (currentUser.role === ROLES.SERGEANT) {
                configs.push(
                    { type: CHAT_TYPES.TRAINING, participants: ['cadet001', 'sergeant001'], description: 'Officer training and development' },
                    { type: CHAT_TYPES.TACTICAL, participants: ['corporal001', 'sergeant001'], description: 'Tactical coordination' },
                    { type: CHAT_TYPES.COMMAND, participants: ['sergeant001', 'lieutenant001', 'captain001'], description: 'Command operations' }
                );
            } else if (currentUser.role === ROLES.LIEUTENANT || currentUser.role === ROLES.CAPTAIN) {
                configs.push(
                    { type: CHAT_TYPES.COMMAND, participants: ['officer001', 'lieutenant001', 'captain001'], description: 'Field command operations' },
                    { type: CHAT_TYPES.COMMAND, participants: ['corporal001', 'lieutenant001'], description: 'Supervisory coordination' },
                    { type: CHAT_TYPES.COMMAND, participants: ['sergeant001', 'lieutenant001', 'captain001'], description: 'Strategic planning' },
                    { type: CHAT_TYPES.ADMIN, participants: ['captain001', 'commander001', 'chief001'], description: 'Administrative coordination' }
                );
            } else if (currentUser.role === ROLES.DISPATCHER) {
                configs.push(
                    { type: CHAT_TYPES.DISPATCH, participants: ['officer001', 'dispatcher001'], description: 'Emergency dispatch coordination' },
                    { type: CHAT_TYPES.EMERGENCY, participants: ['dispatcher001', 'sergeant001', 'lieutenant001'], description: 'Emergency response coordination' }
                );
            } else if (currentUser.role === ROLES.DETECTIVE) {
                configs.push(
                    { type: CHAT_TYPES.INVESTIGATION, participants: ['detective001', 'sergeant001'], description: 'Criminal investigation coordination' },
                    { type: CHAT_TYPES.INVESTIGATION, participants: ['detective001', 'captain001'], description: 'Case management and reporting' }
                );
            } else if (currentUser.role.level >= ROLES.COMMANDER.level) {
                configs.push(
                    { type: CHAT_TYPES.ADMIN, participants: ['captain001', 'commander001', 'chief001'], description: 'Department administration' },
                    { type: CHAT_TYPES.COMMAND, participants: ['lieutenant001', 'commander001'], description: 'Strategic command oversight' },
                    { type: CHAT_TYPES.EMERGENCY, participants: ['dispatcher001', 'sergeant001', 'lieutenant001'], description: 'Emergency response oversight' }
                );
            }

            return configs;
        };

        // Check if user can access a chat (based on hierarchy supervision)
        const canAccessChat = (currentUser, chat) => {
            // User can access if they're a participant
            if (chat.participants.includes(currentUser.username)) {
                return true;
            }

            // Higher-ranking users can supervise lower-ranking conversations
            const chatParticipants = chat.participants.map(username => USERS[username]);
            const maxChatLevel = Math.max(...chatParticipants.map(u => u.role.level));

            // If current user's level is higher than all participants, they can supervise
            return currentUser.role.level > maxChatLevel;
        };

        // Get all accessible chats for a user
        const getAccessibleChats = (currentUser) => {
            const allChats = [];

            // Get all possible chat configurations
            Object.values(USERS).forEach(user => {
                const userChats = getChatConfigurations(user);
                userChats.forEach(chat => {
                    const chatId = chat.participants.sort().join('-');
                    if (!allChats.find(c => c.id === chatId)) {
                        allChats.push({ ...chat, id: chatId });
                    }
                });
            });

            // Filter to only accessible chats
            return allChats.filter(chat => canAccessChat(currentUser, chat));
        };

        // Check if current user is supervising a chat
        const isSupervising = (currentUser, chat) => {
            return canAccessChat(currentUser, chat) && !chat.participants.includes(currentUser.username);
        };

        // Local Storage helpers
        const getMessages = () => {
            const stored = localStorage.getItem('messengerMessages');
            return stored ? JSON.parse(stored) : {};
        };

        const saveMessage = (chatId, message) => {
            const messages = getMessages();
            if (!messages[chatId]) {
                messages[chatId] = [];
            }
            messages[chatId].push(message);
            localStorage.setItem('messengerMessages', JSON.stringify(messages));
        };

        // Login Component
        function LoginScreen({ onLogin }) {
            const [selectedUser, setSelectedUser] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (selectedUser) {
                    onLogin(USERS[selectedUser]);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-box">
                        <h1>🚔 PoliceComm</h1>
                        <p>Tactical Communications System</p>
                        <form onSubmit={handleLogin}>
                            <div className="form-group">
                                <label>Select Officer ID</label>
                                <select 
                                    value={selectedUser} 
                                    onChange={(e) => setSelectedUser(e.target.value)}
                                    required
                                >
                                    <option value="">-- Select Officer --</option>
                                    {Object.entries(USERS).map(([username, user]) => (
                                        <option key={username} value={username}>
                                            {user.role.badge} {user.displayName} - {user.role.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <button type="submit" className="btn-login">
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Chat Item Component
        function ChatItem({ chat, isActive, onClick, currentUser }) {
            const messages = getMessages()[chat.id] || [];
            const lastMessage = messages[messages.length - 1];
            const supervising = isSupervising(currentUser, chat);

            const getChatTitle = () => {
                const otherParticipants = chat.participants
                    .filter(p => p !== currentUser.username)
                    .map(p => USERS[p].displayName);
                return otherParticipants.join(', ');
            };

            const getChannelIcon = () => {
                switch(chat.type) {
                    case CHAT_TYPES.PATROL: return '🚔';
                    case CHAT_TYPES.TACTICAL: return '🎯';
                    case CHAT_TYPES.DISPATCH: return '📡';
                    case CHAT_TYPES.INVESTIGATION: return '🔍';
                    case CHAT_TYPES.COMMAND: return '⭐';
                    case CHAT_TYPES.TRAINING: return '🎓';
                    case CHAT_TYPES.ADMIN: return '📋';
                    case CHAT_TYPES.EMERGENCY: return '🚨';
                    default: return '💬';
                }
            };

            const isEmergencyChannel = chat.type === CHAT_TYPES.EMERGENCY;
            const itemClass = `chat-item ${isActive ? 'active' : ''} ${isEmergencyChannel ? 'priority-urgent' : ''}`;

            return (
                <div className={itemClass} onClick={onClick}>
                    <div className="tactical-header"></div>
                    <div className="chat-item-title">
                        {getChannelIcon()} {getChatTitle()}
                        <span className="chat-badge">{chat.type}</span>
                    </div>
                    <div className="chat-item-subtitle">
                        {supervising && '📹 MONITORING • '}
                        {lastMessage ? lastMessage.text : chat.description}
                    </div>
                </div>
            );
        }

        // Message Component
        function Message({ message, currentUser }) {
            const isSent = message.sender === currentUser.username;
            const sender = USERS[message.sender];

            return (
                <div className={`message ${isSent ? 'sent' : 'received'}`}>
                    {!isSent && (
                        <div className="message-header">
                            <span className={`status-indicator status-${sender.status || 'online'}`}></span>
                            <span className="badge-display">{sender.role.badge}</span> {sender.displayName} • {sender.role.name}
                        </div>
                    )}
                    <div className="message-bubble">
                        {message.text}
                    </div>
                    <div className="message-time timestamp-tactical">
                        {new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })} UTC
                    </div>
                </div>
            );
        }

        // Chat Area Component
        function ChatArea({ chat, currentUser }) {
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const messagesEndRef = useRef(null);
            const supervising = isSupervising(currentUser, chat);

            useEffect(() => {
                const loadMessages = () => {
                    const allMessages = getMessages();
                    setMessages(allMessages[chat.id] || []);
                };

                loadMessages();
                const interval = setInterval(loadMessages, 1000);
                return () => clearInterval(interval);
            }, [chat.id]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleSend = (e) => {
                e.preventDefault();
                if (inputText.trim() && !supervising) {
                    const message = {
                        sender: currentUser.username,
                        text: inputText.trim(),
                        timestamp: new Date().toISOString()
                    };
                    saveMessage(chat.id, message);
                    setInputText('');
                    setMessages([...messages, message]);
                }
            };

            const getChatTitle = () => {
                const otherParticipants = chat.participants
                    .filter(p => p !== currentUser.username)
                    .map(p => USERS[p].displayName);
                return otherParticipants.join(', ');
            };

            const getChannelIcon = () => {
                switch(chat.type) {
                    case CHAT_TYPES.PATROL: return '🚔';
                    case CHAT_TYPES.TACTICAL: return '🎯';
                    case CHAT_TYPES.DISPATCH: return '📡';
                    case CHAT_TYPES.INVESTIGATION: return '🔍';
                    case CHAT_TYPES.COMMAND: return '⭐';
                    case CHAT_TYPES.TRAINING: return '🎓';
                    case CHAT_TYPES.ADMIN: return '📋';
                    case CHAT_TYPES.EMERGENCY: return '🚨';
                    default: return '💬';
                }
            };

            return (
                <div className="chat-area" style={{position: 'relative'}}>
                    <div className="secure-indicator">SECURE</div>
                    <div className="chat-header">
                        <div className="tactical-header"></div>
                        <h3>{getChannelIcon()} {getChatTitle()}</h3>
                        <p>{chat.type} • {chat.description}</p>
                    </div>
                    <div className="messages-container">
                        {supervising && (
                            <div className="supervision-notice">
                                <span>📹</span>
                                <div>
                                    <strong>COMMAND OVERSIGHT:</strong> You are monitoring this secure channel. 
                                    All communications are logged and visible due to your command authority.
                                </div>
                            </div>
                        )}
                        {messages.map((msg, idx) => (
                            <Message key={idx} message={msg} currentUser={currentUser} />
                        ))}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="input-area">
                        {supervising ? (
                            <div style={{ textAlign: 'center', color: '#999', fontStyle: 'italic' }}>
                                COMMAND OVERSIGHT MODE - Monitoring only. Communications restricted to authorized channel participants.
                            </div>
                        ) : (
                            <form onSubmit={handleSend} className="input-container">
                                <input
                                    type="text"
                                    placeholder="Enter message... [SECURE LINE]"
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                />
                                <button type="submit" className="btn-send">Send</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [selectedChat, setSelectedChat] = useState(null);
            const [accessibleChats, setAccessibleChats] = useState([]);

            useEffect(() => {
                if (currentUser) {
                    const chats = getAccessibleChats(currentUser);
                    setAccessibleChats(chats);
                    if (chats.length > 0 && !selectedChat) {
                        setSelectedChat(chats[0]);
                    }
                }
            }, [currentUser]);

            const handleLogout = () => {
                setCurrentUser(null);
                setSelectedChat(null);
            };

            if (!currentUser) {
                return (
                    <div style={{position: 'relative'}}>
                        <div className="secure-indicator">SECURE LOGIN</div>
                        <LoginScreen onLogin={setCurrentUser} />
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="app-header">
                        <h1>🚔 PoliceComm</h1>
                        <div className="user-info">
                            <div className="user-badge">
                                {currentUser.role.badge} {currentUser.displayName} • {currentUser.role.name}
                            </div>
                            <button className="btn-logout" onClick={handleLogout}>
                                Logout
                            </button>
                        </div>
                    </div>
                    <div className="main-content">
                        <div className="sidebar">
                            <div className="sidebar-header">
                                <h2>Channels</h2>
                                <p style={{ fontSize: '13px', color: '#666' }}>
                                    {accessibleChats.length} active channel{accessibleChats.length !== 1 ? 's' : ''}
                                </p>
                            </div>
                            <div className="chat-list">
                                {accessibleChats.map(chat => (
                                    <ChatItem
                                        key={chat.id}
                                        chat={chat}
                                        isActive={selectedChat?.id === chat.id}
                                        onClick={() => setSelectedChat(chat)}
                                        currentUser={currentUser}
                                    />
                                ))}
                            </div>
                        </div>
                        {selectedChat ? (
                            <ChatArea chat={selectedChat} currentUser={currentUser} />
                        ) : (
                            <div className="chat-area">
                                <div className="empty-state">
                                    <div className="empty-state-icon">📶</div>
                                    <h3>No channel selected</h3>
                                    <p>Select a communication channel to begin</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
